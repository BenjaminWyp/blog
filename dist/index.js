"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const path = require("path");
const session = require("express-session");
const connectMongo = require("connect-mongo");
const flash = require("connect-flash");
const configLite = require("config-lite");
const routes_1 = require("./routes");
const winston = require("winston");
const expressWinston = require("express-winston");
require("source-map-support/register");
//Instead of:
const sourceMapSupport = require("source-map-support");
sourceMapSupport.install();
// Promise.resolve().then(() => {
//     const a = 4;
//     a.split('1');
// })
// process.on('unhandledRejection', console.log)
const app = express();
const MongoStore = connectMongo(session);
const config = configLite(__dirname);
// view set
console.log(__dirname);
app.set('views', path.join(`${__dirname}/../`, 'views'));
app.set('view engine', 'ejs');
// 设置静态文件目录
app.use(express.static(path.join(`${__dirname}/../`, 'public')));
// session 中间件
app.use(session({
    name: config.session.key,
    secret: config.session.secret,
    resave: true,
    saveUninitialized: false,
    cookie: {
        maxAge: config.session.maxAge // 过期时间，过期后 cookie 中的 session id 自动删除
    },
    store: new MongoStore({
        url: config.mongodb // mongodb 地址
    })
}));
// 成功日志
app.use(expressWinston.logger({
    transports: [
        new winston.transports.Console({
        //json: true,
        //colorize: true,
        }),
        new winston.transports.File({
            filename: 'logs/success.log',
        })
    ]
}));
// flash 中间件，用来显示通知
app.use(flash());
// 错误请求的日志
app.use(expressWinston.errorLogger({
    transports: [
        new winston.transports.Console({
        //json: true,
        //colorize: true
        }),
        new winston.transports.File({
            filename: 'logs/error.log'
        })
    ]
}));
app.locals.blog = {
    title: config.name,
    description: config.description,
};
app.use((req, res, next) => {
    res.locals.user = req.session.user;
    res.locals.success = req.flash('success').toString();
    res.locals.error = req.flash('error').toString();
    next();
});
// 处理表单及文件上传的中间件
app.use(require('express-formidable')({
    uploadDir: path.join(`../${__dirname}`, 'public/img'),
    keepExtensions: true // 保留后缀
}));
// routes
routes_1.default(app);
// 错误处理
app.use((e, req, res, next) => {
    console.error(e);
    req.flash('error', e.message);
    res.redirect('/posts');
});
if (module.parent) {
    module.exports = app;
}
else {
    app.listen(8000);
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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IiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XG5pbXBvcnQgKiBhcyBjb25uZWN0TW9uZ28gZnJvbSAnY29ubmVjdC1tb25nbyc7XG5pbXBvcnQgZmxhc2ggPSByZXF1aXJlKCdjb25uZWN0LWZsYXNoJyk7XG5pbXBvcnQgKiBhcyBjb25maWdMaXRlIGZyb20gJ2NvbmZpZy1saXRlJztcbmltcG9ydCByb3V0ZXMgZnJvbSAnLi9yb3V0ZXMnO1xuaW1wb3J0ICogYXMgd2luc3RvbiBmcm9tICd3aW5zdG9uJztcbmltcG9ydCAqIGFzIGV4cHJlc3NXaW5zdG9uIGZyb20gJ2V4cHJlc3Mtd2luc3Rvbic7XG5pbXBvcnQgJ3NvdXJjZS1tYXAtc3VwcG9ydC9yZWdpc3Rlcic7XG4vL0luc3RlYWQgb2Y6XG5pbXBvcnQgKiBhcyBzb3VyY2VNYXBTdXBwb3J0IGZyb20gJ3NvdXJjZS1tYXAtc3VwcG9ydCdcbnNvdXJjZU1hcFN1cHBvcnQuaW5zdGFsbCgpXG5cbi8vIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuLy8gICAgIGNvbnN0IGEgPSA0O1xuLy8gICAgIGEuc3BsaXQoJzEnKTtcbi8vIH0pXG4vLyBwcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCBjb25zb2xlLmxvZylcblxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xuY29uc3QgTW9uZ29TdG9yZSA9IGNvbm5lY3RNb25nbyhzZXNzaW9uKTtcbmNvbnN0IGNvbmZpZyA9IGNvbmZpZ0xpdGUoX19kaXJuYW1lKTtcblxuLy8gdmlldyBzZXRcbmNvbnNvbGUubG9nKF9fZGlybmFtZSk7XG5hcHAuc2V0KCd2aWV3cycsIHBhdGguam9pbihgJHtfX2Rpcm5hbWV9Ly4uL2AsICd2aWV3cycpKTtcbmFwcC5zZXQoJ3ZpZXcgZW5naW5lJywgJ2VqcycpO1xuXG4vLyDorr7nva7pnZnmgIHmlofku7bnm67lvZVcbmFwcC51c2UoZXhwcmVzcy5zdGF0aWMocGF0aC5qb2luKGAke19fZGlybmFtZX0vLi4vYCwgJ3B1YmxpYycpKSlcblxuLy8gc2Vzc2lvbiDkuK3pl7Tku7ZcbmFwcC51c2Uoc2Vzc2lvbih7XG4gICAgbmFtZTogY29uZmlnLnNlc3Npb24ua2V5LCAvLyDorr7nva4gY29va2llIOS4reS/neWtmCBzZXNzaW9uIGlkIOeahOWtl+auteWQjeensFxuICAgIHNlY3JldDogY29uZmlnLnNlc3Npb24uc2VjcmV0LCAvLyDpgJrov4forr7nva4gc2VjcmV0IOadpeiuoeeulyBoYXNoIOWAvOW5tuaUvuWcqCBjb29raWUg5Lit77yM5L2/5Lqn55Sf55qEIHNpZ25lZENvb2tpZSDpmLLnr6HmlLlcbiAgICByZXNhdmU6IHRydWUsIC8vIOW8uuWItuabtOaWsCBzZXNzaW9uXG4gICAgc2F2ZVVuaW5pdGlhbGl6ZWQ6IGZhbHNlLCAvLyDorr7nva7kuLogZmFsc2XvvIzlvLrliLbliJvlu7rkuIDkuKogc2Vzc2lvbu+8jOWNs+S9v+eUqOaIt+acqueZu+W9lVxuICAgIGNvb2tpZToge1xuICAgICAgbWF4QWdlOiBjb25maWcuc2Vzc2lvbi5tYXhBZ2UvLyDov4fmnJ/ml7bpl7TvvIzov4fmnJ/lkI4gY29va2llIOS4reeahCBzZXNzaW9uIGlkIOiHquWKqOWIoOmZpFxuICAgIH0sXG4gICAgc3RvcmU6IG5ldyBNb25nb1N0b3JlKHsvLyDlsIYgc2Vzc2lvbiDlrZjlgqjliLAgbW9uZ29kYlxuICAgICAgdXJsOiBjb25maWcubW9uZ29kYi8vIG1vbmdvZGIg5Zyw5Z2AXG4gICAgfSlcbn0pKVxuXG4vLyDmiJDlip/ml6Xlv5dcbmFwcC51c2UoZXhwcmVzc1dpbnN0b24ubG9nZ2VyKHtcbiAgICB0cmFuc3BvcnRzOiBbXG4gICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSh7XG4gICAgICAgICAgICAvL2pzb246IHRydWUsXG4gICAgICAgICAgICAvL2NvbG9yaXplOiB0cnVlLFxuICAgICAgICB9KSxcbiAgICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5GaWxlKHtcbiAgICAgICAgICAgIGZpbGVuYW1lOiAnbG9ncy9zdWNjZXNzLmxvZycsXG4gICAgICAgIH0pXG4gICAgXVxufSkpXG5cbi8vIGZsYXNoIOS4remXtOS7tu+8jOeUqOadpeaYvuekuumAmuefpVxuYXBwLnVzZShmbGFzaCgpKTtcblxuLy8g6ZSZ6K+v6K+35rGC55qE5pel5b+XXG5hcHAudXNlKGV4cHJlc3NXaW5zdG9uLmVycm9yTG9nZ2VyKHtcbiAgICB0cmFuc3BvcnRzOiBbXG4gICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xuICAgICAgICAvL2pzb246IHRydWUsXG4gICAgICAgIC8vY29sb3JpemU6IHRydWVcbiAgICAgIH0pLFxuICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5GaWxlKHtcbiAgICAgICAgZmlsZW5hbWU6ICdsb2dzL2Vycm9yLmxvZydcbiAgICAgIH0pXG4gICAgXVxufSkpXG5cbmFwcC5sb2NhbHMuYmxvZyA9IHtcbiAgICB0aXRsZTogY29uZmlnLm5hbWUsXG4gICAgZGVzY3JpcHRpb246IGNvbmZpZy5kZXNjcmlwdGlvbixcbn07XG5cbmFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgcmVzLmxvY2Fscy51c2VyID0gcmVxLnNlc3Npb24udXNlcjtcbiAgICByZXMubG9jYWxzLnN1Y2Nlc3MgPSByZXEuZmxhc2goJ3N1Y2Nlc3MnKS50b1N0cmluZygpXG4gICAgcmVzLmxvY2Fscy5lcnJvciA9IHJlcS5mbGFzaCgnZXJyb3InKS50b1N0cmluZygpO1xuICAgIG5leHQoKTtcbn0pO1xuXG4vLyDlpITnkIbooajljZXlj4rmlofku7bkuIrkvKDnmoTkuK3pl7Tku7ZcbmFwcC51c2UocmVxdWlyZSgnZXhwcmVzcy1mb3JtaWRhYmxlJykoe1xuICAgIHVwbG9hZERpcjogcGF0aC5qb2luKGAuLi8ke19fZGlybmFtZX1gLCAncHVibGljL2ltZycpLCAvLyDkuIrkvKDmlofku7bnm67lvZVcbiAgICBrZWVwRXh0ZW5zaW9uczogdHJ1ZS8vIOS/neeVmeWQjue8gFxufSkpO1xuXG4vLyByb3V0ZXNcbnJvdXRlcyhhcHApO1xuXG4vLyDplJnor6/lpITnkIZcbmFwcC51c2UoKGUsIHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgY29uc29sZS5lcnJvcihlKVxuICAgIHJlcS5mbGFzaCgnZXJyb3InLCBlLm1lc3NhZ2UpXG4gICAgcmVzLnJlZGlyZWN0KCcvcG9zdHMnKVxufSk7XG5cbmlmKG1vZHVsZS5wYXJlbnQpe1xuICAgIG1vZHVsZS5leHBvcnRzID0gYXBwO1xufWVsc2V7XG4gICAgYXBwLmxpc3Rlbig4MDAwKTtcbn1cbiJdfQ==
