"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const check_1 = require("../middlewares/check");
const posts_1 = require("../models/posts");
const comments_1 = require("../models/comments");
const router = express.Router();
router.get('/', (req, res, next) => {
    const author = req.query.author;
    posts_1.default.getPosts(author).then(posts => {
        res.render('posts', { posts: posts });
    }).catch(next);
});
router.get('/create', check_1.checkLogin, (req, res) => {
    res.render('create');
});
router.post('/create', check_1.checkLogin, (req, res, next) => {
    const author = req.session.user._id;
    const title = req.fields.title;
    const content = req.fields.content;
    try {
        if (!title.length) {
            throw new Error('请填写标题');
        }
        if (!content.length) {
            throw new Error('请填写内容');
        }
    }
    catch (e) {
        req.flash('error', e.message);
        res.redirect('back');
    }
    let post = {
        author,
        title,
        content,
    };
    posts_1.default.create(post).then(result => {
        req.flash('success', '发表成功');
        res.redirect('/posts/' + result.ops[0]);
    }).catch(next);
});
router.get('/:postId', check_1.checkLogin, (req, res, next) => {
    const postId = req.params.postId;
    Promise.all([
        posts_1.default.getPostById(postId),
        comments_1.default.getComments(postId),
        posts_1.default.incPv(postId),
    ]).then(result => {
        const post = result[0];
        const comments = result[1];
        if (!post) {
            throw new Error();
        }
        res.render('post', {
            post: post,
            comments: comments,
        });
    }).catch(next);
});
router.get('/:postId/edit', check_1.checkLogin, (req, res, next) => {
    const postId = req.params.postId;
    const author = req.session.user._id;
    posts_1.default.getRawPostById(postId).then(post => {
        console.log(post);
        if (!post) {
            throw new Error('该文章不存在');
        }
        if (author.toString() !== post.author._id.toString()) {
            throw new Error('权限不足');
        }
        res.render('edit', { post: post });
    }).catch(next);
});
// POST /posts/:postId/edit 更新一篇文章
router.post('/:postId/edit', check_1.checkLogin, (req, res, next) => {
    const postId = req.params.postId;
    const author = req.session.user._id;
    const title = req.fields.title;
    const content = req.fields.content;
    // 校验参数
    try {
        if (!title.length) {
            throw new Error('请填写标题');
        }
        if (!content.length) {
            throw new Error('请填写内容');
        }
    }
    catch (e) {
        req.flash('error', e.message);
        return res.redirect('back');
    }
    posts_1.default.getRawPostById(postId).then(post => {
        if (!post) {
            throw new Error('文章不存在');
        }
        if (post.author._id.toString() !== author.toString()) {
            throw new Error('没有权限');
        }
        posts_1.default.updatePostById(postId, { title: title, content: content }).then(function () {
            req.flash('success', '编辑文章成功');
            // 编辑成功后跳转到上一页
            res.redirect(`/posts/${postId}`);
        }).catch(next);
    });
});
router.get('/:postId/remove', check_1.checkLogin, (req, res, next) => {
    const postId = req.params.postId;
    const author = req.session.user._id;
    posts_1.default.getRawPostById(postId).then(function (post) {
        if (!post) {
            throw new Error('文章不存在');
        }
        if (post.author._id.toString() !== author.toString()) {
            throw new Error('没有权限');
        }
        posts_1.default.delPostById(postId)
            .then(function () {
            req.flash('success', '删除文章成功');
            // 删除成功后跳转到主页
            res.redirect('/posts');
        })
            .catch(next);
    });
});
exports.default = router;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQTtZQUM5QixhQUFhO1lBQ2IsR0FBRyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUN4QixDQUFDLENBQUM7YUFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDaEIsQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDLENBQUMsQ0FBQztBQUVILGtCQUFlLE1BQU0sQ0FBQyIsImZpbGUiOiJyb3V0ZXMvcG9zdHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgY2hlY2tMb2dpbiB9IGZyb20gJy4uL21pZGRsZXdhcmVzL2NoZWNrJztcbmltcG9ydCBQb3N0TW9kZWwgZnJvbSAnLi4vbW9kZWxzL3Bvc3RzJztcbmltcG9ydCBDb21tZW50TW9kZWwgZnJvbSAnLi4vbW9kZWxzL2NvbW1lbnRzJztcblxuY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcblxucm91dGVyLmdldCgnLycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIGNvbnN0IGF1dGhvciA9IHJlcS5xdWVyeS5hdXRob3I7XG4gICAgUG9zdE1vZGVsLmdldFBvc3RzKGF1dGhvcikudGhlbihwb3N0cyA9PiB7XG4gICAgICAgIHJlcy5yZW5kZXIoJ3Bvc3RzJywge3Bvc3RzOiBwb3N0c30pO1xuICAgIH0pLmNhdGNoKG5leHQpO1xufSk7XG5cbnJvdXRlci5nZXQoJy9jcmVhdGUnLCBjaGVja0xvZ2luLCAocmVxLCByZXMpID0+IHtcbiAgICByZXMucmVuZGVyKCdjcmVhdGUnKTtcbn0pO1xuXG5yb3V0ZXIucG9zdCgnL2NyZWF0ZScsIGNoZWNrTG9naW4sIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIGNvbnN0IGF1dGhvcjogc3RyaW5nID0gcmVxLnNlc3Npb24udXNlci5faWQ7XG4gICAgY29uc3QgdGl0bGU6IHN0cmluZyA9IHJlcS5maWVsZHMudGl0bGUgYXMgc3RyaW5nO1xuICAgIGNvbnN0IGNvbnRlbnQ6IHN0cmluZyA9IHJlcS5maWVsZHMuY29udGVudCBhcyBzdHJpbmc7XG5cbiAgICB0cnl7XG4gICAgICAgIGlmICghdGl0bGUubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+ivt+Whq+WGmeagh+mimCcpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb250ZW50Lmxlbmd0aCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfor7floavlhpnlhoXlrrknKVxuICAgICAgICB9XG4gICAgfWNhdGNoKGUpe1xuICAgICAgICByZXEuZmxhc2goJ2Vycm9yJywgZS5tZXNzYWdlKTtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCdiYWNrJyk7XG4gICAgfVxuXG4gICAgaW50ZXJmYWNlIFBvc3Qge1xuICAgICAgICBhdXRob3I6IHN0cmluZyxcbiAgICAgICAgdGl0bGU6IHN0cmluZyxcbiAgICAgICAgY29udGVudDogc3RyaW5nLFxuICAgIH1cbiAgICBsZXQgcG9zdDogUG9zdCA9IHtcbiAgICAgICAgYXV0aG9yLFxuICAgICAgICB0aXRsZSxcbiAgICAgICAgY29udGVudCxcbiAgICB9XG5cbiAgICBQb3N0TW9kZWwuY3JlYXRlKHBvc3QpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgcmVxLmZsYXNoKCdzdWNjZXNzJywgJ+WPkeihqOaIkOWKnycpO1xuICAgICAgICByZXMucmVkaXJlY3QoJy9wb3N0cy8nICsgcmVzdWx0Lm9wc1swXSk7XG4gICAgfSkuY2F0Y2gobmV4dCk7XG59KTtcblxucm91dGVyLmdldCgnLzpwb3N0SWQnLCBjaGVja0xvZ2luLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBjb25zdCBwb3N0SWQgPSByZXEucGFyYW1zLnBvc3RJZDtcblxuICAgIFByb21pc2UuYWxsKFtcbiAgICAgICAgUG9zdE1vZGVsLmdldFBvc3RCeUlkKHBvc3RJZCksIC8vIOiOt+WPluaWh+eroOS/oeaBr1xuICAgICAgICBDb21tZW50TW9kZWwuZ2V0Q29tbWVudHMocG9zdElkKSwgLy8g6I635Y+W6K+l5paH56ug5omA5pyJ55WZ6KiAXG4gICAgICAgIFBvc3RNb2RlbC5pbmNQdihwb3N0SWQpLCAvLyBwdiDliqAgMVxuICAgIF0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgY29uc3QgcG9zdCA9IHJlc3VsdFswXTtcbiAgICAgICAgY29uc3QgY29tbWVudHMgPSByZXN1bHRbMV07XG4gICAgICAgIGlmKCFwb3N0KXtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgICAgICB9XG4gICAgICAgIHJlcy5yZW5kZXIoJ3Bvc3QnLCB7XG4gICAgICAgICAgICBwb3N0OiBwb3N0LFxuICAgICAgICAgICAgY29tbWVudHM6IGNvbW1lbnRzLFxuICAgICAgICB9KTtcbiAgICB9KS5jYXRjaChuZXh0KTtcbn0pO1xuXG5yb3V0ZXIuZ2V0KCcvOnBvc3RJZC9lZGl0JywgY2hlY2tMb2dpbiwgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgY29uc3QgcG9zdElkID0gcmVxLnBhcmFtcy5wb3N0SWQ7XG4gICAgY29uc3QgYXV0aG9yID0gcmVxLnNlc3Npb24udXNlci5faWQ7XG5cbiAgICBQb3N0TW9kZWwuZ2V0UmF3UG9zdEJ5SWQocG9zdElkKS50aGVuKHBvc3QgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhwb3N0KTtcbiAgICAgICAgaWYoIXBvc3Qpe1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfor6Xmlofnq6DkuI3lrZjlnKgnKTtcbiAgICAgICAgfVxuICAgICAgICBpZihhdXRob3IudG9TdHJpbmcoKSAhPT0gcG9zdC5hdXRob3IuX2lkLnRvU3RyaW5nKCkpe1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfmnYPpmZDkuI3otrMnKVxuICAgICAgICB9XG5cbiAgICAgICAgcmVzLnJlbmRlcignZWRpdCcsIHtwb3N0OiBwb3N0fSk7XG4gICAgfSkuY2F0Y2gobmV4dCk7XG59KTtcblxuLy8gUE9TVCAvcG9zdHMvOnBvc3RJZC9lZGl0IOabtOaWsOS4gOevh+aWh+eroFxucm91dGVyLnBvc3QoJy86cG9zdElkL2VkaXQnLCBjaGVja0xvZ2luLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBjb25zdCBwb3N0SWQgPSByZXEucGFyYW1zLnBvc3RJZDtcbiAgICBjb25zdCBhdXRob3IgPSByZXEuc2Vzc2lvbi51c2VyLl9pZDtcbiAgICBjb25zdCB0aXRsZSA9IHJlcS5maWVsZHMudGl0bGU7XG4gICAgY29uc3QgY29udGVudCAgPSByZXEuZmllbGRzLmNvbnRlbnQ7XG5cbiAgICAvLyDmoKHpqozlj4LmlbBcbiAgICB0cnkge1xuICAgICAgICBpZiAoIXRpdGxlLmxlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+ivt+Whq+WGmeagh+mimCcpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb250ZW50Lmxlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+ivt+Whq+WGmeWGheWuuScpXG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJlcS5mbGFzaCgnZXJyb3InLCBlLm1lc3NhZ2UpXG4gICAgICAgIHJldHVybiByZXMucmVkaXJlY3QoJ2JhY2snKVxuICAgIH1cblxuICAgIFBvc3RNb2RlbC5nZXRSYXdQb3N0QnlJZChwb3N0SWQpLnRoZW4ocG9zdCA9PiB7XG4gICAgICAgIGlmICghcG9zdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfmlofnq6DkuI3lrZjlnKgnKVxuICAgICAgICB9XG4gICAgICAgIGlmIChwb3N0LmF1dGhvci5faWQudG9TdHJpbmcoKSAhPT0gYXV0aG9yLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcign5rKh5pyJ5p2D6ZmQJylcbiAgICAgICAgfVxuXG4gICAgICAgIFBvc3RNb2RlbC51cGRhdGVQb3N0QnlJZChwb3N0SWQsIHsgdGl0bGU6IHRpdGxlLCBjb250ZW50OiBjb250ZW50IH0pLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmVxLmZsYXNoKCdzdWNjZXNzJywgJ+e8lui+keaWh+eroOaIkOWKnycpXG4gICAgICAgICAgICAvLyDnvJbovpHmiJDlip/lkI7ot7PovazliLDkuIrkuIDpobVcbiAgICAgICAgICAgIHJlcy5yZWRpcmVjdChgL3Bvc3RzLyR7cG9zdElkfWApXG4gICAgICAgIH0pLmNhdGNoKG5leHQpXG4gICAgfSlcbn0pO1xuXG5yb3V0ZXIuZ2V0KCcvOnBvc3RJZC9yZW1vdmUnLCBjaGVja0xvZ2luLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBjb25zdCBwb3N0SWQgPSByZXEucGFyYW1zLnBvc3RJZDtcbiAgICBjb25zdCBhdXRob3IgPSByZXEuc2Vzc2lvbi51c2VyLl9pZDtcblxuICAgIFBvc3RNb2RlbC5nZXRSYXdQb3N0QnlJZChwb3N0SWQpLnRoZW4oZnVuY3Rpb24gKHBvc3QpIHtcbiAgICAgIGlmICghcG9zdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+aWh+eroOS4jeWtmOWcqCcpXG4gICAgICB9XG4gICAgICBpZiAocG9zdC5hdXRob3IuX2lkLnRvU3RyaW5nKCkgIT09IGF1dGhvci50b1N0cmluZygpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcign5rKh5pyJ5p2D6ZmQJylcbiAgICAgIH1cbiAgICAgIFBvc3RNb2RlbC5kZWxQb3N0QnlJZChwb3N0SWQpXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICByZXEuZmxhc2goJ3N1Y2Nlc3MnLCAn5Yig6Zmk5paH56ug5oiQ5YqfJylcbiAgICAgICAgICAvLyDliKDpmaTmiJDlip/lkI7ot7PovazliLDkuLvpobVcbiAgICAgICAgICByZXMucmVkaXJlY3QoJy9wb3N0cycpXG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChuZXh0KVxuICAgIH0pXG59KTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyO1xuIl19
